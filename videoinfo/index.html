<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åƒç´ è§†é¢‘é‡å‘½åå·¥å…·</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  
  <!-- é…ç½®Tailwindè‡ªå®šä¹‰ä¸»é¢˜ -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            retro: {
              bg: '#0f172a',
              panel: '#1e293b',
              accent: '#3b82f6',
              text: '#e2e8f0',
              highlight: '#facc15',
              success: '#10b981',
              danger: '#ef4444'
            }
          },
          fontFamily: {
            pixel: ['"Press Start 2P"', 'monospace', 'system-ui']
          }
        }
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .pixel-border {
        box-shadow: 4px 4px 0 #000;
        border: 2px solid #fff;
      }
      .pixel-button {
        @apply bg-retro-accent hover:bg-blue-600 text-white font-pixel text-sm py-2 px-4 
               transition-all duration-150 active:translate-x-1 active:translate-y-1 
               active:shadow-none pixel-border;
      }
      .retro-input {
        @apply bg-retro-panel border-2 border-white px-2 py-1 font-pixel text-sm 
               text-retro-text focus:outline-none focus:border-retro-highlight;
      }
      .rule-item {
        @apply bg-retro-panel border-2 border-white px-3 py-2 mb-2 flex items-center gap-2
               cursor-move font-pixel text-sm;
      }
      .retro-checkbox {
        @apply w-4 h-4 bg-retro-panel border-2 border-white text-retro-highlight 
               focus:ring-0 accent-retro-highlight;
      }
    }
  </style>
  
  <!-- å¼•å…¥åƒç´ å­—ä½“ -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body class="bg-retro-bg text-retro-text min-h-screen p-4 md:p-8">
  <!-- å¯¼èˆªæ  -->
  <nav class="bg-retro-panel pixel-border p-4 mb-6">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <a href="../index.html" class="text-retro-text hover:text-retro-highlight transition-colors duration-200">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
        </a>
        <h1 class="font-pixel text-retro-highlight text-sm">è§†é¢‘é‡å‘½åå·¥å…·</h1>
      </div>
      <div class="hidden md:flex items-center space-x-6">
        <a href="../index.html" class="font-pixel text-xs text-retro-text hover:text-retro-highlight transition-colors duration-200">å·¥å…·</a>
        <a href="../ascii/" class="font-pixel text-xs text-retro-text hover:text-retro-highlight transition-colors duration-200">ASCIIè½¬æ¢</a>
        <a href="../time/" class="font-pixel text-xs text-retro-text hover:text-retro-highlight transition-colors duration-200">æ—¶é—´è®¡ç®—</a>
        <a href="../connectivity/" class="font-pixel text-xs text-retro-text hover:text-retro-highlight transition-colors duration-200">è¿é€šæ€§æµ‹è¯•</a>
        <a href="../bg/" class="font-pixel text-xs text-retro-text hover:text-retro-highlight transition-colors duration-200">è”ç³»</a>
      </div>
      <div class="md:hidden">
        <button id="mobile-menu-btn" class="text-retro-text hover:text-retro-highlight focus:outline-none">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </div>
    </div>
    <!-- ç§»åŠ¨ç«¯èœå• -->
    <div id="mobile-menu" class="md:hidden hidden mt-4 pt-4 border-t border-white/20">
      <div class="space-y-2">
        <a href="../index.html" class="block font-pixel text-xs text-retro-text hover:text-retro-highlight transition-colors duration-200 py-2">å·¥å…·</a>
        <a href="../ascii/" class="block font-pixel text-xs text-retro-text hover:text-retro-highlight transition-colors duration-200 py-2">ASCIIè½¬æ¢</a>
        <a href="../time/" class="block font-pixel text-xs text-retro-text hover:text-retro-highlight transition-colors duration-200 py-2">æ—¶é—´è®¡ç®—</a>
        <a href="../connectivity/" class="block font-pixel text-xs text-retro-text hover:text-retro-highlight transition-colors duration-200 py-2">è¿é€šæ€§æµ‹è¯•</a>
        <a href="../bg/" class="block font-pixel text-xs text-retro-text hover:text-retro-highlight transition-colors duration-200 py-2">è”ç³»</a>
      </div>
    </div>
  </nav>

  <!-- æ ‡é¢˜åŒºåŸŸ -->
  <header class="mb-6 text-center">
    <h1 class="font-pixel text-retro-highlight text-xl md:text-2xl mb-2 tracking-tight">è§†é¢‘æ‰¹é‡é‡å‘½åå·¥å…·</h1>
    <p class="font-pixel text-xs text-retro-text/70">å¤å¤é£æ ¼ Â· ç®€å•é«˜æ•ˆ</p>
  </header>

  <main class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- å·¦ä¾§ï¼šæ–‡ä»¶é€‰æ‹©åŒº -->
    <section class="md:col-span-1">
      <div class="bg-retro-panel pixel-border p-4 h-full">
        <h2 class="font-pixel text-retro-highlight text-sm mb-4">é€‰æ‹©è§†é¢‘æ–‡ä»¶</h2>
        
        <div class="mb-4">
          <label for="fileInput" class="pixel-button w-full block text-center mb-3">
            é€‰æ‹©æ–‡ä»¶
          </label>
          <input type="file" id="fileInput" accept="video/*" multiple class="hidden" />
          
          <div id="fileList" class="max-h-60 overflow-y-auto text-xs font-pixel space-y-1">
            <p class="text-retro-text/60">æœªé€‰æ‹©ä»»ä½•æ–‡ä»¶</p>
          </div>
        </div>
        
        <div class="text-xs font-pixel text-retro-text/70">
          <p>æ”¯æŒæ ¼å¼ï¼šMP4ã€WebMã€MOVç­‰</p>
          <p class="mt-1">æç¤ºï¼šæŒ‰ä½Ctrlé”®å¯å¤šé€‰æ–‡ä»¶</p>
        </div>
      </div>
    </section>

    <!-- ä¸­é—´ï¼šå‘½åè§„åˆ™é…ç½® -->
    <section class="md:col-span-1">
      <div class="bg-retro-panel pixel-border p-4 h-full">
        <h2 class="font-pixel text-retro-highlight text-sm mb-4">å‘½åè§„åˆ™è®¾ç½®</h2>
        
        <div class="mb-4">
          <p class="font-pixel text-xs mb-2">å¯ç”¨å…ƒç´ ï¼š</p>
          <div class="space-y-2">
            <label class="flex items-center gap-2 text-xs font-pixel">
              <input type="checkbox" class="retro-checkbox" data-type="duration1" checked>
              <span>æ—¶é•¿ (2h30m1sæ ¼å¼)</span>
            </label>
            <label class="flex items-center gap-2 text-xs font-pixel">
              <input type="checkbox" class="retro-checkbox" data-type="duration2">
              <span>æ—¶é•¿ (2_30_1æ ¼å¼)</span>
            </label>
            <label class="flex items-center gap-2 text-xs font-pixel">
              <input type="checkbox" class="retro-checkbox" data-type="timestamp" checked>
              <span>å½“å‰æ—¶é—´æˆ³</span>
            </label>
            <label class="flex items-center gap-2 text-xs font-pixel">
              <input type="checkbox" class="retro-checkbox" data-type="custom">
              <span>è‡ªå®šä¹‰æ–‡æœ¬ï¼š</span>
              <input type="text" class="retro-input text-xs w-24" id="customText" placeholder="è¾“å…¥æ–‡å­—">
            </label>
          </div>
        </div>
        
        <div>
          <p class="font-pixel text-xs mb-2">å‘½åé¡ºåºï¼ˆæ‹–æ‹½è°ƒæ•´ï¼‰ï¼š</p>
          <div id="ruleOrder" class="space-y-1 min-h-[120px]">
            <div class="rule-item" data-type="duration1">
              <span>â±ï¸ æ—¶é•¿(2h30m1s)</span>
            </div>
            <div class="rule-item" data-type="timestamp">
              <span>ğŸ“… å½“å‰æ—¶é—´æˆ³</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- å³ä¾§ï¼šé¢„è§ˆå’Œæ“ä½œ -->
    <section class="md:col-span-1">
      <div class="bg-retro-panel pixel-border p-4 h-full">
        <h2 class="font-pixel text-retro-highlight text-sm mb-4">é¢„è§ˆä¸æ“ä½œ</h2>
        
        <div class="mb-4">
          <p class="font-pixel text-xs mb-2">åˆ†éš”ç¬¦ï¼š</p>
          <select id="separator" class="retro-input text-xs">
            <option value="-">- æ¨ªçº¿</option>
            <option value="_" selected>_ ä¸‹åˆ’çº¿</option>
            <option value=" "> ç©ºæ ¼</option>
            <option value=".">. ç‚¹</option>
          </select>
        </div>
        
        <div class="mb-4">
          <p class="font-pixel text-xs mb-2">é¢„è§ˆï¼š</p>
          <div id="previewArea" class="max-h-40 overflow-y-auto text-xs font-pixel space-y-1 p-2 bg-retro-bg border border-white">
            <p class="text-retro-text/60">é€‰æ‹©æ–‡ä»¶åæ˜¾ç¤ºé¢„è§ˆ</p>
          </div>
        </div>
        
        <div class="space-y-3">
          <button id="generateBtn" class="pixel-button w-full bg-retro-success hover:bg-green-700" disabled>
            ç”Ÿæˆå¹¶ä¸‹è½½
          </button>
          <button id="clearBtn" class="pixel-button w-full bg-retro-danger hover:bg-red-700">
            æ¸…é™¤æ‰€æœ‰
          </button>
        </div>
      </div>
    </section>
  </main>

  <!-- åº•éƒ¨çŠ¶æ€æ  -->
  <footer class="mt-8 text-center">
    <div class="bg-retro-panel pixel-border p-2 inline-block">
      <p class="font-pixel text-xs text-retro-text/70">çŠ¶æ€: å°±ç»ª | åƒç´ å·¥å…· v1.0</p>
    </div>
  </footer>

  <script>
    // ç§»åŠ¨ç«¯èœå•åŠŸèƒ½
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const mobileMenu = document.getElementById('mobile-menu');
    
    if (mobileMenuBtn && mobileMenu) {
      mobileMenuBtn.addEventListener('click', () => {
        const isHidden = mobileMenu.classList.contains('hidden');
        
        if (isHidden) {
          mobileMenu.classList.remove('hidden');
        } else {
          mobileMenu.classList.add('hidden');
        }
      });
      
      // ç‚¹å‡»èœå•é¡¹åå…³é—­èœå•
      const mobileMenuLinks = mobileMenu.querySelectorAll('a');
      mobileMenuLinks.forEach(link => {
        link.addEventListener('click', () => {
          mobileMenu.classList.add('hidden');
        });
      });
    }

    // å…¨å±€å˜é‡
    let selectedFiles = [];
    let fileDurations = new Map(); // å­˜å‚¨æ–‡ä»¶æ—¶é•¿ä¿¡æ¯
    
    // DOMå…ƒç´ 
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const ruleCheckboxes = document.querySelectorAll('.retro-checkbox[data-type]');
    const customTextInput = document.getElementById('customText');
    const ruleOrder = document.getElementById('ruleOrder');
    const separatorSelect = document.getElementById('separator');
    const previewArea = document.getElementById('previewArea');
    const generateBtn = document.getElementById('generateBtn');
    const clearBtn = document.getElementById('clearBtn');
    
    // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
    function initDragAndDrop() {
      const ruleItems = document.querySelectorAll('.rule-item');
      
      ruleItems.forEach(item => {
        item.setAttribute('draggable', true);
        
        item.addEventListener('dragstart', (e) => {
          e.dataTransfer.setData('text/plain', item.dataset.type);
          setTimeout(() => item.classList.add('opacity-50'), 0);
        });
        
        item.addEventListener('dragend', () => {
          item.classList.remove('opacity-50');
          updatePreview();
        });
        
        item.addEventListener('dragover', (e) => {
          e.preventDefault();
          const draggable = document.querySelector('.opacity-50');
          const afterElement = getDragAfterElement(ruleOrder, e.clientY);
          
          if (afterElement == null) {
            ruleOrder.appendChild(draggable);
          } else {
            ruleOrder.insertBefore(draggable, afterElement);
          }
        });
      });
    }
    
    // è¾…åŠ©å‡½æ•°ï¼šç¡®å®šæ‹–æ‹½å…ƒç´ çš„æ”¾ç½®ä½ç½®
    function getDragAfterElement(container, y) {
      const draggableElements = [...container.querySelectorAll('.rule-item:not(.opacity-50)')];
      
      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        
        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }
    
    // è§£æè§†é¢‘æ—¶é•¿
    function getVideoDuration(file) {
      return new Promise((resolve) => {
        const video = document.createElement('video');
        video.preload = 'metadata';
        video.src = URL.createObjectURL(file);
        
        video.onloadedmetadata = () => {
          URL.revokeObjectURL(video.src);
          resolve(video.duration);
        };
        
        video.onerror = () => {
          resolve(null); // æ— æ³•è§£ææ—¶é•¿
        };
      });
    }
    
    // æ ¼å¼åŒ–æ—¶é•¿ - 2h30m1sæ ¼å¼
    function formatDuration1(seconds) {
      if (!seconds) return 'æœªçŸ¥æ—¶é•¿';
      
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = Math.floor(seconds % 60);
      
      let result = '';
      if (h > 0) result += `${h}h`;
      if (m > 0) result += `${m}m`;
      result += `${s}s`;
      
      return result;
    }
    
    // æ ¼å¼åŒ–æ—¶é•¿ - 2_30_1æ ¼å¼
    function formatDuration2(seconds) {
      if (!seconds) return 'æœªçŸ¥æ—¶é•¿';
      
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = Math.floor(seconds % 60);
      
      return `${h}_${m}_${s}`;
    }
    
    // è·å–å½“å‰æ—¶é—´æˆ³å­—ç¬¦ä¸²
    function getCurrentTimestamp() {
      const date = new Date();
      return `${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate().toString().padStart(2,'0')}_${date.getHours().toString().padStart(2,'0')}${date.getMinutes().toString().padStart(2,'0')}`;
    }
    
    // æ›´æ–°æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤º
    function updateFileList() {
      if (selectedFiles.length === 0) {
        fileList.innerHTML = '<p class="text-retro-text/60">æœªé€‰æ‹©ä»»ä½•æ–‡ä»¶</p>';
        generateBtn.disabled = true;
        return;
      }
      
      fileList.innerHTML = '';
      selectedFiles.forEach((file, index) => {
        const fileItem = document.createElement('div');
        fileItem.className = 'flex justify-between items-center p-1 hover:bg-retro-bg';
        fileItem.innerHTML = `
          <span class="truncate max-w-[180px]">${index + 1}. ${file.name}</span>
          <span class="text-retro-text/60 text-[10px]">${(file.size / 1024 / 1024).toFixed(1)}MB</span>
        `;
        fileList.appendChild(fileItem);
      });
      
      generateBtn.disabled = false;
      updatePreview();
    }
    
    // æ›´æ–°å‘½åè§„åˆ™é¡ºåº
    function updateRuleOrder() {
      // æ¸…ç©ºç°æœ‰è§„åˆ™
      ruleOrder.innerHTML = '';
      
      // æ·»åŠ é€‰ä¸­çš„è§„åˆ™
      ruleCheckboxes.forEach(checkbox => {
        if (checkbox.checked) {
          const ruleItem = document.createElement('div');
          ruleItem.className = 'rule-item';
          ruleItem.dataset.type = checkbox.dataset.type;
          
          let label = '';
          switch(checkbox.dataset.type) {
            case 'duration1': label = 'â±ï¸ æ—¶é•¿(2h30m1s)'; break;
            case 'duration2': label = 'â±ï¸ æ—¶é•¿(2_30_1)'; break;
            case 'timestamp': label = 'ğŸ“… å½“å‰æ—¶é—´æˆ³'; break;
            case 'custom': label = 'ğŸ“ è‡ªå®šä¹‰æ–‡æœ¬'; break;
          }
          
          ruleItem.innerHTML = `<span>${label}</span>`;
          ruleOrder.appendChild(ruleItem);
        }
      });
      
      // é‡æ–°åˆå§‹åŒ–æ‹–æ‹½
      initDragAndDrop();
      updatePreview();
    }
    
    // æ›´æ–°é¢„è§ˆ
    async function updatePreview() {
      if (selectedFiles.length === 0) {
        previewArea.innerHTML = '<p class="text-retro-text/60">é€‰æ‹©æ–‡ä»¶åæ˜¾ç¤ºé¢„è§ˆ</p>';
        return;
      }
      
      previewArea.innerHTML = '';
      const separator = separatorSelect.value;
      const ruleItems = ruleOrder.querySelectorAll('.rule-item');
      const customText = customTextInput.value || 'è‡ªå®šä¹‰';
      const timestamp = getCurrentTimestamp();
      
      // ç¡®ä¿æ‰€æœ‰æ–‡ä»¶æ—¶é•¿éƒ½å·²åŠ è½½
      for (const file of selectedFiles) {
        if (!fileDurations.has(file.name)) {
          const duration = await getVideoDuration(file);
          fileDurations.set(file.name, duration);
        }
      }
      
      // ç”Ÿæˆé¢„è§ˆ
      selectedFiles.forEach((file, index) => {
        const nameParts = [];
        const duration = fileDurations.get(file.name);
        
        ruleItems.forEach(item => {
          switch(item.dataset.type) {
            case 'duration1': 
              nameParts.push(formatDuration1(duration));
              break;
            case 'duration2': 
              nameParts.push(formatDuration2(duration));
              break;
            case 'timestamp': 
              nameParts.push(timestamp);
              break;
            case 'custom': 
              nameParts.push(customText);
              break;
          }
        });
        
        // è·å–æ–‡ä»¶æ‰©å±•å
        const ext = file.name.split('.').pop();
        const newName = `${nameParts.join(separator)}.${ext}`;
        
        const previewItem = document.createElement('div');
        previewItem.className = 'flex flex-col';
        previewItem.innerHTML = `
          <span class="text-retro-text/60">åŸ: ${file.name.substring(0, 20)}${file.name.length > 20 ? '...' : ''}</span>
          <span class="text-retro-highlight">æ–°: ${newName.substring(0, 25)}${newName.length > 25 ? '...' : ''}</span>
        `;
        previewArea.appendChild(previewItem);
      });
    }
    
    // ç”Ÿæˆå¹¶ä¸‹è½½é‡å‘½ååçš„æ–‡ä»¶
    async function generateAndDownload() {
      const zip = new JSZip();
      const separator = separatorSelect.value;
      const ruleItems = ruleOrder.querySelectorAll('.rule-item');
      const customText = customTextInput.value || 'è‡ªå®šä¹‰';
      const timestamp = getCurrentTimestamp();
      
      // ä¸ºæ¯ä¸ªæ–‡ä»¶ç”Ÿæˆæ–°åç§°å¹¶æ·»åŠ åˆ°ZIP
      for (const file of selectedFiles) {
        const nameParts = [];
        const duration = fileDurations.get(file.name);
        const ext = file.name.split('.').pop();
        
        ruleItems.forEach(item => {
          switch(item.dataset.type) {
            case 'duration1': 
              nameParts.push(formatDuration1(duration));
              break;
            case 'duration2': 
              nameParts.push(formatDuration2(duration));
              break;
            case 'timestamp': 
              nameParts.push(timestamp);
              break;
            case 'custom': 
              nameParts.push(customText);
              break;
          }
        });
        
        const newName = `${nameParts.join(separator)}.${ext}`;
        zip.file(newName, file);
      }
      
      // ç”ŸæˆZIPæ–‡ä»¶å¹¶ä¸‹è½½
      zip.generateAsync({ type: "blob" })
        .then(content => {
          saveAs(content, `é‡å‘½åæ–‡ä»¶_${timestamp}.zip`);
        });
    }
    
    // æ¸…é™¤æ‰€æœ‰é€‰æ‹©
    function clearAll() {
      selectedFiles = [];
      fileDurations.clear();
      fileInput.value = '';
      updateFileList();
      previewArea.innerHTML = '<p class="text-retro-text/60">é€‰æ‹©æ–‡ä»¶åæ˜¾ç¤ºé¢„è§ˆ</p>';
    }
    
    // äº‹ä»¶ç›‘å¬
    fileInput.addEventListener('change', async (e) => {
      selectedFiles = Array.from(e.target.files);
      updateFileList();
    });
    
    ruleCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', updateRuleOrder);
    });
    
    customTextInput.addEventListener('input', updatePreview);
    separatorSelect.addEventListener('change', updatePreview);
    generateBtn.addEventListener('click', generateAndDownload);
    clearBtn.addEventListener('click', clearAll);
    
    // åˆå§‹åŒ–
    initDragAndDrop();
  </script>
</body>
</html>