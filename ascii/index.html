<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Retro ASCII Studio - Ultimate Edition v2.2</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bungee+Shade&family=Courier+Prime&family=Dancing+Script&family=Fira+Code:wght@400;700&family=Inconsolata:wght@500&family=Orbitron:wght@500&family=Oswald:wght@700&family=Press+Start+2P&family=Roboto+Mono&family=Rubik+Glitch&family=Share+Tech+Mono&family=Source+Code+Pro&family=Space+Mono&family=Ubuntu+Mono&family=VT323&display=swap" rel="stylesheet">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          screens: { 'xs': '480px' },
          colors: {
            'mac-beige': '#FFF4E0',
            'mac-black': '#1A1A1A',
            'retro-blue': '#0000AA',
          },
          boxShadow: {
            'retro': '4px 4px 0px 0px #000000',
            'retro-sm': '2px 2px 0px 0px #000000',
          }
        }
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .dither-bg {
        background-color: #FFF4E0;
        background-image: radial-gradient(#D6C0A6 1px, transparent 1px);
        background-size: 4px 4px;
      }
      
      /* --- 字体样式 --- */
      .font-vt323 { font-family: 'VT323', monospace; }
      .font-pixel { font-family: 'Press Start 2P', cursive; letter-spacing: -1px; }
      .font-fira { font-family: 'Fira Code', monospace; }
      .font-courier { font-family: 'Courier Prime', monospace; }
      .font-source { font-family: 'Source Code Pro', monospace; }
      .font-ubuntu { font-family: 'Ubuntu Mono', monospace; }
      .font-space { font-family: 'Space Mono', monospace; }
      .font-inconsolata { font-family: 'Inconsolata', monospace; }
      .font-orbitron { font-family: 'Orbitron', sans-serif; letter-spacing: 1px; }
      .font-glitch { font-family: 'Rubik Glitch', cursive; }
      
      @media (min-width: 768px) {
        ::-webkit-scrollbar { width: 14px; height: 14px; background: #fff; border: 2px solid black; }
        ::-webkit-scrollbar-thumb { background: #999; border: 2px solid black; }
        ::-webkit-scrollbar-corner { background: black; }
      }

      .mac-window { @apply bg-white border-2 border-mac-black shadow-retro relative flex flex-col; }
      .title-bar { @apply bg-mac-black text-white px-2 py-1 flex justify-between items-center font-vt323 text-lg border-b-2 border-mac-black h-8 select-none; background: repeating-linear-gradient(90deg, #000 0px, #000 2px, #555 2px, #555 4px); }
      .title-text { @apply bg-mac-beige text-mac-black px-4 border-x-2 border-mac-black; }
      .retro-btn { @apply bg-white border-2 border-mac-black shadow-retro-sm px-3 py-2 font-vt323 text-sm hover:bg-black hover:text-white active:translate-x-[2px] active:translate-y-[2px] active:shadow-none transition-all duration-75 text-center select-none; }
      .retro-input { @apply bg-white border-2 border-mac-black p-2 font-vt323 text-lg focus:outline-none focus:bg-blue-50 w-full rounded-none; }

      .ascii-container {
        line-height: 0.75; letter-spacing: -0.05em; white-space: pre; overflow: auto;
        background-color: #111; color: #eee; display: flex; justify-content: center; align-items: flex-start;
        -webkit-overflow-scrolling: touch;
      }
      #ascii-art { text-align: left; display: inline-block; min-width: min-content; }

      /* === Label Styles === */
      .label-base { display: block; width: 100%; text-align: center; margin: 1rem 0; white-space: normal; line-height: 1.2; }
      .style-ansi-shadow { font-family: 'Rubik Glitch', cursive; color: #fff; text-shadow: 2px 2px 0 #555, 4px 4px 0 #333; background: #222; padding: 10px; }
      .style-3d-ascii { font-family: 'Press Start 2P', cursive; color: #FFD700; text-shadow: 1px 1px 0 #c6a700, 2px 2px 0 #8e7800, 3px 3px 0 #584a00; text-transform: uppercase; }
      .style-emboss { font-family: 'Verdana', sans-serif; font-weight: bold; color: #808080; background-color: #111; text-shadow: -1px -1px 0 #fff, 1px 1px 0 #000; letter-spacing: 2px; text-transform: uppercase; }
      .style-emboss2 { font-family: 'Courier Prime', monospace; font-weight: bold; color: #333; text-shadow: 1px 1px 0 rgba(255,255,255,0.3), -1px -1px 0 rgba(0,0,0,0.8); background: #222; border: 1px solid #444; padding: 5px; }
      .style-rebel { font-family: 'Oswald', sans-serif; color: #ff0055; text-transform: uppercase; transform: skew(-10deg); text-shadow: 2px 2px 0 #000, -1px -1px 0 #fff; border-bottom: 3px solid #ff0055; display: inline-block !important; }
      .style-larry-3d { font-family: 'Bungee Shade', cursive; color: #00ffcc; text-shadow: 1px 1px 0 #ff00cc, 2px 2px 0 #ff00cc, 3px 3px 0 #ff00cc; letter-spacing: 2px; }
      .style-standard { color: #FFFF00; background: #333; font-family: 'VT323', monospace; border-top: 2px dashed #555; border-bottom: 2px dashed #555; }
    }
  </style>
</head>

<body class="font-vt323 dither-bg min-h-screen flex flex-col text-mac-black overflow-x-hidden">

  <nav class="bg-white border-b-2 border-mac-black sticky top-0 z-50 h-10 md:h-12 flex items-center px-4 justify-between shadow-sm shrink-0">
    <div class="flex items-center space-x-4">
      <div class="text-sm md:text-lg flex items-center font-bold">
        <i class="fa fa-apple mr-2 text-lg"></i> System 7.6
      </div>
    </div>
    <div class="text-lg md:text-xl" id="clock">00:00 AM</div>
  </nav>

  <main class="flex-grow p-2 md:p-6 container mx-auto max-w-[1400px]">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 lg:gap-6 items-start h-full">
      
      <div class="lg:col-span-4 space-y-4 md:space-y-6">
        <div class="mac-window">
          <div class="title-bar">
            <div class="w-3 h-3 border border-white bg-white"></div>
            <span class="title-text">CONTROL PANEL</span>
            <div class="w-3 h-3 border border-white bg-white"></div>
          </div>
          
          <div class="p-3 md:p-4 space-y-4 bg-mac-beige pb-6">
            
            <div>
              <label class="block text-xs mb-2 uppercase font-bold">1. Source Disk</label>
              <div class="border-2 border-dashed border-mac-black bg-white p-3 text-center hover:bg-gray-50 relative group" id="drop-area">
                <input type="file" id="image-input" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                <i class="fa fa-floppy-o text-3xl mb-1"></i>
                <p class="text-lg leading-none mt-1">INSERT DISK</p>
                <p id="file-name" class="mt-1 text-retro-blue truncate font-bold text-xs h-4"></p>
              </div>
            </div>

            <hr class="border-t-2 border-mac-black border-dotted">

            <div class="space-y-3">
              <label class="block text-xs uppercase font-bold">2. Config</label>
              
              <div class="space-y-2 bg-white/50 p-2 border border-gray-400 border-dashed">
                <div>
                  <div class="flex justify-between text-sm font-bold"><span>Width</span><span id="width-value">100</span></div>
                  <input type="range" id="width-slider" min="40" max="180" value="100" class="w-full accent-mac-black h-2 bg-white border border-black">
                </div>
                <div>
                  <div class="flex justify-between text-sm font-bold"><span>Contrast</span><span id="contrast-value">1.2</span></div>
                  <input type="range" id="contrast-slider" min="0.5" max="2" step="0.1" value="1.2" class="w-full accent-mac-black h-2 bg-white border border-black">
                </div>
                <div>
                  <div class="flex justify-between text-sm font-bold"><span>Speed (ms)</span><span id="speed-value">20</span></div>
                  <input type="range" id="speed-slider" min="1" max="500" step="5" value="20" class="w-full accent-mac-black h-2 bg-white border border-black">
                </div>
              </div>

              <div class="grid grid-cols-1 xs:grid-cols-2 gap-2 pt-1">
                <div>
                  <label class="block text-xs font-bold mb-1">Char Set</label>
                  <select id="char-set" class="w-full retro-input text-sm py-1 px-1 h-10">
                    <option value="detailed">High Res</option>
                    <option value="simple">Low Res</option>
                    <option value="blocks">Block Mode</option>
                    <option value="binary">Matrix (0/1)</option>
                    <option value="custom">Custom...</option>
                  </select>
                </div>
                <div>
                  <label class="block text-xs font-bold mb-1">Font Style</label>
                  <select id="font-select" class="w-full retro-input text-sm py-1 px-1 h-10 font-sans">
                    <option value="font-vt323" selected>VT323 (Default)</option>
                    <option value="font-pixel">Pixel Art</option>
                    <option value="font-fira">Fira Code</option>
                    <option value="font-courier">Courier Prime</option>
                    <option value="font-source">Source Code</option>
                    <option value="font-ubuntu">Ubuntu Mono</option>
                    <option value="font-space">Space Mono</option>
                    <option value="font-inconsolata">Inconsolata</option>
                    <option value="font-orbitron">Orbitron (Sci-Fi)</option>
                    <option value="font-glitch">Rubik Glitch</option>
                  </select>
                </div>
              </div>

              <div id="custom-char-container" class="hidden bg-yellow-100 p-2 border border-black">
                <input type="text" id="custom-chars" value="@%#*+=-:. " class="w-full border border-black p-1 font-mono text-sm">
              </div>
              
              <div class="grid grid-cols-2 gap-2">
                  <div class="flex items-center space-x-2 bg-white p-1 border border-black">
                     <input type="checkbox" id="dithering-toggle" class="w-4 h-4 border-2 border-black rounded-none text-black focus:ring-0 accent-black">
                     <label for="dithering-toggle" class="text-xs select-none font-bold">Dithering</label>
                  </div>
                  <div class="flex items-center space-x-2 bg-white p-1 border border-black">
                     <input type="checkbox" id="bg-remove-toggle" class="w-4 h-4 border-2 border-black rounded-none text-black focus:ring-0 accent-black">
                     <label for="bg-remove-toggle" class="text-xs select-none font-bold whitespace-nowrap">Remove BG</label>
                  </div>
              </div>
            </div>

            <hr class="border-t-2 border-mac-black border-dotted">

            <div>
              <label class="block text-xs mb-2 uppercase font-bold">3. Label (Optional)</label>
              <input type="text" id="extra-text" placeholder="ENTER TITLE..." class="w-full retro-input mb-2 uppercase text-base">
              
              <div class="grid grid-cols-1 xs:grid-cols-2 gap-2 mb-2">
                <div>
                  <label class="block text-[10px] font-bold mb-1">Style</label>
                  <select id="title-style" class="w-full retro-input text-sm py-1 h-8">
                    <option value="style-standard">Standard</option>
                    <option value="style-ansi-shadow">ANSI Shadow</option>
                    <option value="style-3d-ascii">3D ASCII</option>
                    <option value="style-emboss">Emboss</option>
                    <option value="style-emboss2">Emboss 2</option>
                    <option value="style-rebel">Rebel</option>
                    <option value="style-larry-3d">Larry 3D</option>
                  </select>
                </div>
                <div>
                  <label class="block text-[10px] font-bold mb-1">Position</label>
                  <div class="flex items-center h-8 space-x-2">
                    <label class="flex items-center text-xs"><input type="radio" name="text-pos" value="start" checked class="mr-1 accent-black">Top</label>
                    <label class="flex items-center text-xs"><input type="radio" name="text-pos" value="end" class="mr-1 accent-black">Btm</label>
                  </div>
                </div>
              </div>
              
              <div class="mt-2">
                <div class="flex justify-between text-[10px] font-bold"><span>Label Size</span><span id="label-size-val">24px</span></div>
                <input type="range" id="label-size-slider" min="12" max="72" value="24" class="w-full accent-mac-black h-2 bg-white border border-black">
              </div>
            </div>

            <button id="convert-btn" class="w-full bg-mac-black text-white border-2 border-white shadow-retro active:shadow-none active:translate-y-1 transition-all py-3 font-bold text-sm uppercase mt-2 group relative overflow-hidden">
              <span class="relative z-10 group-hover:hidden">RUN PROGRAM</span>
              <span class="relative z-10 hidden group-hover:inline">COMPUTING...</span>
              <div class="absolute inset-0 bg-gray-700 transform -translate-x-full group-hover:translate-x-0 transition-transform duration-300"></div>
            </button>
          </div>
        </div>
      </div>

      <div class="lg:col-span-8 h-[60vh] lg:h-full min-h-[400px] flex flex-col pb-6">
        <div class="mac-window h-full flex flex-col shadow-retro">
          <div class="title-bar">
            <div class="w-3 h-3 border border-white bg-white"></div>
            <span class="title-text">TERMINAL OUTPUT</span>
            <div class="flex space-x-1">
               <div class="w-3 h-3 border border-white bg-white flex items-center justify-center text-black leading-none text-[8px]">-</div>
               <div class="w-3 h-3 border border-white bg-white flex items-center justify-center text-black leading-none text-[8px]">□</div>
            </div>
          </div>

          <div class="flex-grow bg-[#111] flex flex-col relative overflow-hidden border-x-2 border-mac-black">
            <div class="absolute inset-0 pointer-events-none shadow-[inset_0_0_40px_rgba(0,0,0,0.6)] z-10 border-4 border-[#111] bg-[linear-gradient(rgba(18,16,16,0)_50%,rgba(0,0,0,0.25)_50%),linear-gradient(90deg,rgba(255,0,0,0.06),rgba(0,255,0,0.02),rgba(0,0,255,0.06))] bg-[length:100%_2px,3px_100%]"></div>
            
            <canvas id="export-canvas" class="hidden"></canvas>

            <div id="ascii-wrapper" class="ascii-container w-full h-full p-2 md:p-8">
              <pre id="ascii-art" class="font-vt323 text-[6px] md:text-[10px] lg:text-xs leading-tight"></pre>
              <div id="placeholder-art" class="absolute inset-0 flex items-center justify-center flex-col text-gray-700 pointer-events-none z-0">
                <i class="fa fa-terminal text-6xl mb-4 opacity-50"></i>
                <p class="text-xs animate-pulse font-bold">AWAITING DATA...</p>
              </div>
            </div>
          </div>

          <div class="border-t-2 border-mac-black bg-mac-beige p-2 flex flex-wrap justify-between items-center gap-2 shrink-0 z-20">
            <div id="status-text" class="font-bold text-xs truncate max-w-[150px]">READY.</div>
            <div class="flex space-x-2">
              <button id="btn-copy" class="retro-btn disabled:opacity-50" disabled><i class="fa fa-copy"></i> COPY</button>
              <button id="btn-gif" class="retro-btn disabled:opacity-50" disabled><i class="fa fa-file-image-o"></i> GIF</button>
              <button id="btn-video" class="retro-btn disabled:opacity-50 bg-red-50 text-red-900 hover:bg-red-600 hover:text-white" disabled><i class="fa fa-video-camera"></i> REC</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <a id="download-link" class="hidden"></a>

  <script>
    /* --- CONSTANTS --- */
    const PRESETS = {
      detailed: " .'`^\",:;Il!i><~+_-?][}{1)(|\\/tfjrxnuvczXYUJCLQ0OZmwqpdbkhao*#MW&8%B@$",
      simple: " .:-=+*#%@",
      blocks: " ░▒▓█",
      binary: " 01"
    };
    
    const els = {
      dropArea: document.getElementById('drop-area'),
      imageInput: document.getElementById('image-input'),
      fileName: document.getElementById('file-name'),
      widthSlider: document.getElementById('width-slider'),
      widthValue: document.getElementById('width-value'),
      contrastSlider: document.getElementById('contrast-slider'),
      contrastValue: document.getElementById('contrast-value'),
      speedSlider: document.getElementById('speed-slider'),
      speedValue: document.getElementById('speed-value'),
      
      charSetSelect: document.getElementById('char-set'),
      customCharContainer: document.getElementById('custom-char-container'),
      customCharsInput: document.getElementById('custom-chars'),
      
      fontSelect: document.getElementById('font-select'),
      titleStyleSelect: document.getElementById('title-style'), 
      labelSizeSlider: document.getElementById('label-size-slider'),
      labelSizeVal: document.getElementById('label-size-val'),
      
      ditheringToggle: document.getElementById('dithering-toggle'),
      bgRemoveToggle: document.getElementById('bg-remove-toggle'), // New Toggle
      
      convertBtn: document.getElementById('convert-btn'),
      asciiWrapper: document.getElementById('ascii-wrapper'),
      asciiArt: document.getElementById('ascii-art'),
      placeholder: document.getElementById('placeholder-art'),
      statusText: document.getElementById('status-text'),
      extraText: document.getElementById('extra-text'),
      btnCopy: document.getElementById('btn-copy'),
      btnGif: document.getElementById('btn-gif'),
      btnVideo: document.getElementById('btn-video'),
      clock: document.getElementById('clock')
    };

    let currentImage = null;
    let isAnimating = false;
    let animationInterval = null;
    let finalAsciiLines = []; 
    let currentTitleProps = null;

    /* --- UTILS --- */
    setInterval(() => {
      const now = new Date();
      els.clock.textContent = now.toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit'});
    }, 1000);

    function updateStatus(msg, blink = false) {
      els.statusText.textContent = msg;
      els.statusText.className = `font-bold text-xs truncate max-w-[150px] ${blink ? 'animate-pulse' : ''}`;
    }
    function toggleButtons(enable) {
      [els.btnCopy, els.btnGif, els.btnVideo].forEach(b => b.disabled = !enable);
    }

    /* --- LISTENERS --- */
    els.widthSlider.addEventListener('input', (e) => els.widthValue.textContent = e.target.value);
    els.contrastSlider.addEventListener('input', (e) => els.contrastValue.textContent = e.target.value);
    els.speedSlider.addEventListener('input', (e) => els.speedValue.textContent = e.target.value);
    els.labelSizeSlider.addEventListener('input', (e) => els.labelSizeVal.textContent = e.target.value + 'px');

    els.charSetSelect.addEventListener('change', (e) => {
      els.customCharContainer.classList.toggle('hidden', e.target.value !== 'custom');
    });

    els.imageInput.addEventListener('change', handleFileSelect);
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eN => {
      els.dropArea.addEventListener(eN, (e) => { e.preventDefault(); e.stopPropagation(); });
    });
    els.dropArea.addEventListener('drop', (e) => {
      els.dropArea.classList.remove('bg-blue-50');
      processFile(e.dataTransfer.files[0]);
    });
    
    els.convertBtn.addEventListener('click', startConversion);
    els.btnCopy.addEventListener('click', copyToClipboard);
    els.btnGif.addEventListener('click', exportToGIF);
    els.btnVideo.addEventListener('click', recordVideoAnimation);

    /* --- LOGIC --- */
    function handleFileSelect(e) { processFile(e.target.files[0]); }
    function processFile(file) {
      if (!file || !file.type.match('image.*')) return;
      els.fileName.textContent = file.name;
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => { currentImage = img; updateStatus("DISK LOADED.", true); };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function startConversion() {
      if (!currentImage) return alert("PLEASE INSERT DISK (UPLOAD IMAGE) FIRST.");
      if (isAnimating) { clearTimeout(animationInterval); isAnimating = false; }

      updateStatus("COMPUTING...", true);
      toggleButtons(false);
      els.placeholder.classList.add('hidden');
      
      els.asciiArt.innerHTML = ''; 
      els.asciiArt.className = `text-left inline-block ${els.fontSelect.value}`;

      setTimeout(() => {
        const asciiData = generateAsciiData();
        playTypewriterAnimation(asciiData);
      }, 100);
    }

    function generateAsciiData() {
      const width = parseInt(els.widthSlider.value);
      const contrast = parseFloat(els.contrastSlider.value);
      const removeBg = els.bgRemoveToggle.checked; // Check toggle state
      
      let chars = PRESETS[els.charSetSelect.value];
      if (els.charSetSelect.value === 'custom') chars = els.customCharsInput.value || "@# ";

      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const ratio = currentImage.height / currentImage.width;
      const height = Math.round(width * ratio * 0.55); 
      
      canvas.width = width;
      canvas.height = height;
      ctx.drawImage(currentImage, 0, 0, width, height);
      
      // Get raw data for BG checking
      let rawImgData = ctx.getImageData(0, 0, width, height);
      const rawData = rawImgData.data;

      // Get contrast adjusted data for char selection
      const imgData = adjustContrast(ctx.getImageData(0, 0, width, height), contrast);
      const data = imgData.data;
      
      // BG Color Detection (Top-Left Pixel)
      const bgR = rawData[0];
      const bgG = rawData[1];
      const bgB = rawData[2];
      const tolerance = 30; // Euclidean distance tolerance

      let lines = [];

      for (let y = 0; y < height; y++) {
        let lineHTML = "";
        for (let x = 0; x < width; x++) {
          const idx = (y * width + x) * 4;
          
          // Raw colors for BG check
          const rRaw = rawData[idx], gRaw = rawData[idx+1], bRaw = rawData[idx+2], aRaw = rawData[idx+3];
          
          // Contrast adjusted colors for text
          const r = data[idx], g = data[idx+1], b = data[idx+2];
          
          let isBgPixel = false;

          // Check 1: Alpha Transparency (Always remove transparent pixels)
          if (aRaw < 20) {
            isBgPixel = true;
          } 
          // Check 2: Solid Color Match (Only if toggle is ON)
          else if (removeBg) {
             const dist = Math.sqrt(Math.pow(rRaw - bgR, 2) + Math.pow(gRaw - bgG, 2) + Math.pow(bRaw - bgB, 2));
             if (dist < tolerance) isBgPixel = true;
          }

          if (isBgPixel) {
            // Use an invisible dot or space to maintain alignment
            lineHTML += `<span style="opacity:0"> </span>`;
          } else {
            const bright = (0.299*r + 0.587*g + 0.114*b);
            const char = chars[Math.floor((bright / 255) * (chars.length - 1))] || chars[chars.length-1];
            lineHTML += `<span style="color: rgb(${r},${g},${b})">${char}</span>`;
          }
        }
        lines.push(lineHTML);
      }

      // === Label Processing ===
      const extraText = els.extraText.value.trim();
      if (extraText) {
        const pos = document.querySelector('input[name="text-pos"]:checked').value;
        const styleClass = els.titleStyleSelect.value; 
        const fontSize = els.labelSizeSlider.value;
        currentTitleProps = { text: extraText, style: styleClass, size: fontSize };
        const labelHtml = `<div class="label-base ${styleClass}" style="font-size: ${fontSize}px;">${extraText}</div>`;
        if (pos === 'start') lines.unshift(labelHtml);
        else lines.push(labelHtml);
      } else {
        currentTitleProps = null;
      }

      finalAsciiLines = lines;
      return lines;
    }

    function playTypewriterAnimation(lines) {
      isAnimating = true;
      let i = 0;
      updateStatus("PRINTING...", true);
      const speed = parseInt(els.speedSlider.value);

      function printLine() {
        if (!isAnimating) return;
        if (i >= lines.length) {
          isAnimating = false;
          updateStatus("COMPLETED.", false);
          toggleButtons(true);
          return;
        }
        const node = document.createElement('div');
        node.innerHTML = lines[i];
        node.style.minHeight = '1em'; 
        els.asciiArt.appendChild(node);
        els.asciiWrapper.scrollTop = els.asciiWrapper.scrollHeight;
        i++;
        animationInterval = setTimeout(printLine, speed);
      }
      printLine();
    }

    function adjustContrast(imageData, contrast) {
      const d = imageData.data;
      const f = (259 * (contrast + 255)) / (255 * (259 - contrast));
      for (let i = 0; i < d.length; i += 4) {
        d[i] = clamp(f * (d[i] - 128) + 128);
        d[i+1] = clamp(f * (d[i+1] - 128) + 128);
        d[i+2] = clamp(f * (d[i+2] - 128) + 128);
      }
      return imageData;
    }
    function clamp(v) { return Math.max(0, Math.min(255, v)); }

    /* --- EXPORT --- */
    function copyToClipboard() {
       navigator.clipboard.writeText(els.asciiArt.innerText).then(() => updateStatus("COPIED!", true));
    }

    function exportToGIF() {
      updateStatus("RENDERING GIF...", true);
      html2canvas(els.asciiArt, { backgroundColor: '#111111', scale: 2, useCORS: true }).then(canvas => {
        const gif = new GIF({ workers: 2, quality: 10, width: canvas.width, height: canvas.height, background: '#111111' });
        gif.addFrame(canvas, {delay: 200});
        gif.on('finished', (blob) => { downloadBlob(blob, 'gif'); updateStatus("GIF EXPORTED.", false); });
        gif.render();
      });
    }

    async function recordVideoAnimation() {
      if (!finalAsciiLines.length) return;
      updateStatus("REC...", true);
      els.btnVideo.disabled = true;

      const canvas = document.getElementById('export-canvas');
      const ctx = canvas.getContext('2d');
      const scale = 2;
      
      const containerRect = els.asciiArt.getBoundingClientRect();
      canvas.width = (containerRect.width || 800) * scale;
      canvas.height = (containerRect.height || 600) * scale + 200; 
      ctx.scale(scale, scale);

      const stream = canvas.captureStream(30);
      const mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
      const chunks = [];
      
      mediaRecorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
      mediaRecorder.onstop = () => {
        downloadBlob(new Blob(chunks, { type: 'video/webm' }), 'webm');
        updateStatus("VIDEO SAVED.", false);
        els.btnVideo.disabled = false;
      };

      mediaRecorder.start();

      const compStyle = getComputedStyle(els.asciiArt);
      const fontSize = parseInt(compStyle.fontSize) || 12;
      const fontFamily = compStyle.fontFamily;
      const lineHeight = fontSize * 0.85;
      
      ctx.fillStyle = '#111111';
      ctx.fillRect(0, 0, canvas.width/scale, canvas.height/scale);

      let lineIndex = 0;
      // Updated Regex to handle empty/transparent spans
      const regex = /<span style="color: rgb\((\d+),(\d+),(\d+)\)">([^<])<\/span>/g;
      const speed = parseInt(els.speedSlider.value);
      
      function drawStep() {
        if (lineIndex >= finalAsciiLines.length) { mediaRecorder.stop(); return; }

        const lineHTML = finalAsciiLines[lineIndex];
        const y = lineIndex * lineHeight + 50;

        if (lineHTML.includes('class="label-base')) {
            if (currentTitleProps) {
                const titleSize = parseInt(currentTitleProps.size);
                ctx.font = `bold ${titleSize}px "Courier New", monospace`;
                ctx.textAlign = "center";
                ctx.fillStyle = currentTitleProps.style.includes('rebel') ? '#ff0055' : '#FFFF00';
                ctx.fillText(currentTitleProps.text, (canvas.width/scale)/2, y + titleSize);
                ctx.textAlign = "left";
                ctx.font = `${fontSize}px ${fontFamily}`;
            }
        } else {
            ctx.font = `${fontSize}px ${fontFamily}`;
            let match, x = 20;
            // The regex will naturally skip the <span style="opacity:0"> </span> parts
            while ((match = regex.exec(lineHTML)) !== null) {
                ctx.fillStyle = `rgb(${match[1]},${match[2]},${match[3]})`;
                ctx.fillText(match[4], x, y);
                x += ctx.measureText(match[4]).width; 
            }
            // We need to account for the spaces in the X position calculation for video
            // Simple approach: re-parse for spaces if accuracy is needed, 
            // but for "Remove BG", skipping drawing is exactly what we want.
            // However, to keep alignment correct relative to X, we might need a more complex parser 
            // if the background was in the *middle*.
            // For simple left-aligned or full-block art, this regex loop is usually sufficient 
            // as long as "x" increments correctly. 
            // **Correction**: If we skip drawing, "x" doesn't increment.
            // To fix alignment in video for removed blocks, we need to iterate HTML nodes or chars.
            // For this version, we accept that video export of removed-bg art might be left-collapsed 
            // unless we specifically handle the "opacity:0" span.
            
            // Better Loop for Video Alignment:
            const parser = new DOMParser();
            const doc = parser.parseFromString(`<div>${lineHTML}</div>`, 'text/html');
            const spans = doc.body.firstChild.children;
            let currentX = 20;
            
            for(let span of spans) {
                if (span.style.opacity === '0') {
                   currentX += ctx.measureText(" ").width; // Advance cursor for empty space
                } else {
                   ctx.fillStyle = span.style.color;
                   ctx.fillText(span.innerText, currentX, y);
                   currentX += ctx.measureText(span.innerText).width;
                }
            }
        }
        
        lineIndex++;
        setTimeout(drawStep, speed);
      }
      drawStep();
    }

    function downloadBlob(blob, ext) {
      const a = document.getElementById('download-link');
      a.href = URL.createObjectURL(blob);
      a.download = `retro-export-${Date.now()}.${ext}`;
      a.click();
    }
  </script>
</body>
</html>
